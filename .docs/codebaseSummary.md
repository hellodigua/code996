# Code996 CLI 项目架构总结

## 📋 项目概述

Code996 CLI 是一个基于 TypeScript 开发的命令行工具，用于分析 Git 仓库中提交的时间分布，计算项目的"996指数"。该指数基于数学模型，帮助用户了解项目整体的工作时间模式，识别潜在的加班文化。

## 🏗️ 项目结构

```
src/
├── cli/                    # CLI界面层
│   ├── index.ts           # CLI主管理器 - 负责命令注册、参数解析和版本管理
│   └── commands/          # 命令实现
│       ├── analyze.ts     # 分析命令 - 核心执行逻辑与时间范围处理
│       ├── report/        # 报表输出模块（新增）
│       │   ├── index.ts   # 统一导出接口
│       │   ├── printer.ts # 报表打印 - 核心结果、时间分布、加班分析等
│       │   └── analysis.ts # 智能分析与建议生成
│       └── help.ts        # 帮助命令 - 显示使用说明
├── core/                  # 核心算法层
│   ├── calculator.ts      # 996 指数计算
│   ├── end-hour-detector.ts # 下班时间窗口识别
│   ├── work-time-analyzer.ts # 工作时间分析
│   └── overtime-analyzer.ts  # 加班分析（工作日、周末、深夜）
├── git/                   # 数据采集层
│   ├── git-collector.ts   # Git数据采集 - 批量数据收集和处理
│   └── git-parser.ts      # 数据解析和验证 - 数据清洗和996指数计算
├── types/                 # 类型定义
│   └── git-types.ts       # TypeScript类型 - 定义所有数据结构
├── utils/                 # 工具函数
│   ├── terminal.ts        # 终端工具 - 自适应表格和宽度检测
│   ├── formatter.ts       # 格式化工具 - 时间格式化、颜色选择（新增）
│   └── version.ts         # 版本工具 - 读取package.json版本
└── docs/…                 # 文档与示例
```

## 🎯 核心功能模块

### 1. CLI 界面层 (Command Line Interface)

- **命令注册**：使用 Commander.js 注册默认根命令和帮助命令
- **参数解析**：支持年份快捷方式（`-y`）、日期范围（`--since/--until`）、全量分析（`--all-time`）
- **用户交互**：提供彩色输出、自适应表格和进度指示器
- **报表输出**：模块化的报表系统，支持核心结果、详细分析、时间分布、加班分析等多维度展示

### 2. 数据采集层 (Git Collector)

- **数据收集**: 收集仓库的所有提交数据
- **Git命令执行**: 执行 git log、git rev-list 等命令获取提交数据
- **数据验证**: 验证 Git 仓库的有效性和数据完整性
- **时间范围处理**: 支持自定义开始和结束日期

### 3. 核心算法层 (Calculator)

- **996 指数计算**：基于加班比例的数学模型，输出数值与描述
- **工作时间识别**：利用每日首提分位数与晚间拐点推断上下班区间，并在加班计算阶段只保留上班后的前 9 小时作为正常工时
- **附加模块**：`end-hour-detector.ts` 封装下班时间窗口推断逻辑

### 4. 数据解析层 (Git Parser)

- **数据清洗**：解析 git log 输出，转换为结构化数据
- **时间分析**：按小时、按星期统计提交分布
- **工作时间转换**：将原始统计结果交给核心算法识别上下班区间
- **指数计算**：组织数据并交给 calculator 输出最终结果

## 🔄 功能交互流程

### 单仓库分析流程 (默认根命令)

```
用户输入 → CLI 参数解析 → Git 数据采集 → 时间分布统计 → 工作时间推断 → 996 指数计算 → 结果输出
   ↓           ↓              ↓               ↓              ↓           ↓
终端命令   Commander.js    git log        byHour/byDay    分位数+拐点   表格展示
```

## 📊 数据流分析

### 输入数据

- **Git仓库路径**: 默认当前目录，支持指定路径
- **时间范围**:
  - 默认：以上一次提交往前 365 天
  - 年份模式：`-y 2025` 或 `-y 2023-2025` 快速指定年份范围
  - 精确模式：通过 `--since`/`--until` 指定精确日期
  - 全量模式：`--all-time` 分析整个仓库历史

### 数据处理

1. **原始数据采集**：通过 git log 获取小时分布、星期分布与每日首笔提交
2. **数据结构化**：整理为小时数组、星期统计、每日首提等结构
3. **时间分析**：制作 24 小时与工作日/周末分布
4. **工作时间推断**：使用分位数与晚间拐点识别上下班区间
5. **指数计算**：基于加班比例的数学模型生成 996 指数

### 输出数据

- **核心指标**（`printer.ts`）:
  - 996指数: 0-300+ 的数值，表示加班程度
  - 描述等级: 根据指数范围提供中文描述
  - 加班比例: 百分比形式显示加班提交占比
  - 总提交数: 分析时段内的总提交统计
- **详细分析**（`analysis.ts`）:
  - 智能分析: 基于多维度指标的人性化分析文本
  - 综合建议: 根据加班强度给出行动建议（快跑/警惕/可接受/很好等）
- **时间分布**（`printer.ts`）:
  - 24小时提交分布图
  - 工作日/周末分布图
  - 工作时间推测（上下班时间）
- **加班分析**（`printer.ts`）:
  - 工作日加班分布（周一至周五）
  - 周末加班分析（真正加班 vs 临时修复）
  - 深夜加班分析（晚间、深夜、凌晨时段）

## 🔧 核心算法

### 996指数计算公式

```typescript
// 计算加班比例
const overTimeRadio = ((workHourPl[1].count * 1.5 + workWeekPl[1].count * 2) / totalCommits) * 100

// 计算996指数
const index996 = overTimeRadio * 3
```

### 工作时间识别算法

- 统计最近样本的每日首提，过滤清晨与周末噪音
- 取 10%~20% 分位构建上班时间区间，并向下取半小时保证最大覆盖 1 小时
- 对小时分布应用阈值与累积分位，识别晚间提交拐点作为下班区间
- 若未检测到显著拐点，则退回“上班时间 + 9 小时”的标准工时兜底
- 计算 996 指数时仅保留上班后的前 9 小时时段作为正常工时，超出的小时数全部记为加班

## 🛠️ 技术栈

### 核心技术

- **TypeScript 5.x**: 提供完整的类型安全
- **Node.js**: 运行时环境
- **Commander.js**: CLI命令行界面框架
- **Chalk**: 彩色终端输出
- **Ora**: 进度指示器

### 数据处理

- **Git命令行工具**: 数据采集
- **Cli-table3**: 表格格式输出
- **自适应终端宽度**: 响应式表格布局

### 测试与构建

- **Jest**: 单元测试框架
- **TypeScript Compiler**: 代码编译
- **NPM Scripts**: 构建和部署脚本

## 📈 扩展性设计

### 模块化架构

- **清晰的分层设计**：各层职责明确（CLI → 采集 → 解析 → 计算 → 输出）
- **报表模块化**：输出层独立为 `report/` 模块，职责单一易维护
- **工具函数复用**：格式化工具集中在 `utils/formatter.ts`，便于复用
- **模块间低耦合**：模块间通过接口交互，便于独立开发和测试
- **类型定义完整**：支持良好的IDE体验和编译时检查

### 可扩展点

- **新的输出格式**: 在 `report/` 模块中添加新的 Printer（如 JSON、HTML、PDF）
- **新的分析维度**: 在 `analysis.ts` 中扩展智能分析规则
- **算法优化**: 替换或增强工作时间识别算法
- **数据源扩展**: 支持其他版本控制系统（SVN、Mercurial等）
- **国际化支持**: 可以重新添加多语言支持

### 近期重构（v0.1.3）

- ✅ 将 754 行的 `analyze.ts` 拆分为多个职责清晰的模块（减少 73% 代码量）
- ✅ 新增 `report/` 模块：`printer.ts`（报表打印）+ `analysis.ts`（智能分析）
- ✅ 新增 `utils/formatter.ts`：统一管理格式化工具函数
- ✅ 新增 `--year/-y` 参数：支持快速按年份查询（如 `-y 2025` 或 `-y 2023-2025`）

## 🎯 项目特点

### 优势

- **类型安全**: 完整的TypeScript类型定义
- **性能优化**: 批量数据处理和并行计算
- **用户体验**: 彩色输出和进度指示
- **代码质量**: 清晰的架构和完整的错误处理

### 创新点

- **工作时间识别**：基于分位数与晚间拐点的组合推断，兼顾上下班弹性与加班识别
- **自适应表格输出**：根据终端宽度自动调整列宽

这个架构设计体现了现代TypeScript CLI工具的最佳实践，具有良好的可维护性和扩展性。
